name: Build Windows EXE

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - "v*"  # 當推送到 v1.0, v2.0 等標籤時觸發發布
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    outputs:
      exe_path: python/dist/TotalSeg_Launcher.exe

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true
        
    - name: Install PyInstaller & UI Deps
      working-directory: ./python
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller PySide6 pyqtdarktheme
        
    - name: Build EXE with PyInstaller
      working-directory: ./python
      run: |
        # 準備需要打進 EXE 肚子的檔案清單
        # 在 Windows 上，PyInstaller 的 --add-data 語法是 "來源路徑;目標路徑"
        pyinstaller --noconsole --onefile --name "TotalSeg_Launcher" `
          --add-data "pyproject.toml;." `
          --add-data "uv.lock;." `
          --add-data "seg.py;." `
          --add-data "draw.py;." `
          --hidden-import=PySide6.QtCore `
          --hidden-import=PySide6.QtGui `
          --hidden-import=PySide6.QtWidgets `
          gui_pyside.py
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: TotalSeg_Launcher_Windows
        path: python/dist/TotalSeg_Launcher.exe

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: TotalSeg_Launcher_Windows

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: TotalSeg_Launcher.exe
          name: Release ${{ github.ref_name }}
          body: |
            ## TotalSeg Launcher Windows Version
            - 這是自動生成的 Windows 執行檔。
            - 請下載後直接執行，程式會自動初始化環境。
          draft: false
          prerelease: false

